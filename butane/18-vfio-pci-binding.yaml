# Generated by Butane; do not edit
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 18-vfio-pci-binding
spec:
  config:
    ignition:
      version: 3.5.0
    systemd:
      units:
        - contents: |
            [Unit]
            Description=Bind PCI device 0000:04:02.1 to vfio-pci driver
            After=network-online.target
            Before=grout-container.service
            Wants=network-online.target

            [Service]
            Type=oneshot
            RemainAfterExit=yes
            ExecStartPre=/sbin/modprobe vfio-pci
            ExecStart=/bin/bash -c 'echo "vfio-pci" > /sys/bus/pci/devices/0000:04:02.1/driver_override'
            ExecStart=/bin/bash -c 'echo "0000:04:02.1" > /sys/bus/pci/drivers/iavf/unbind || true'
            ExecStart=/bin/bash -c 'echo "0000:04:02.1" > /sys/bus/pci/drivers/vfio-pci/bind'
            ExecStop=/bin/bash -c 'echo "0000:04:02.1" > /sys/bus/pci/drivers/vfio-pci/unbind || true'
            ExecStop=/bin/bash -c 'echo "" > /sys/bus/pci/devices/0000:04:02.1/driver_override'
            ExecStop=/bin/bash -c 'echo "0000:04:02.1" > /sys/bus/pci/drivers/iavf/bind || true'

            [Install]
            WantedBy=multi-user.target
          enabled: true
          name: vfio-pci-binding.service
